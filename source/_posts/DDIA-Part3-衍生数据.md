---
title: "DDIA Part 3：衍生数据"
date: 2025-12-28T10:03:00+08:00
tags:
  - DDIA
  - 批处理
  - 流处理
  - 数据工程
categories:
  - 读书笔记
---

本文是 DDIA 第三部分的读书笔记，涵盖第 10-12 章：批处理、流处理、数据系统的未来。

---

## 第10章：批处理

### 三种系统类型

| 类型 | 特点 | 延迟 | 示例 |
|------|------|------|------|
| 在线服务 | 请求-响应 | 毫秒 | Web API |
| 批处理 | 大量数据，高吞吐 | 分钟~小时 | MapReduce |
| 流处理 | 持续处理数据流 | 毫秒~秒 | Kafka Streams |

### Unix 哲学

> 每个程序做好一件事，输出可成为另一程序的输入

```bash
cat access.log | 
  awk '{print $7}' |    # 提取 URL
  sort | uniq -c |      # 计数
  sort -rn | head -10   # 取前10
```

### MapReduce

```
输入 → Map → Shuffle(按键分组) → Reduce → 输出

示例（词频统计）:
输入: "hello world hello"
Map:  (hello,1) (world,1) (hello,1)
Shuffle: hello:[1,1], world:[1]
Reduce: (hello,2) (world,1)
```

**分布式执行**：数据本地性原则，尽量在数据所在节点执行 Map

### Join 类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| Reduce 端 Join | Shuffle 后按键合并 | 通用 |
| 广播 Join | 小表广播到所有 Map | 大表 Join 小表 |
| 分区 Join | 两表相同分区策略 | 预分区数据 |

### 现代批处理框架

| 框架 | 特点 |
|------|------|
| **Spark** | RDD 抽象，内存缓存，迭代友好 |
| **Flink** | 流批一体，增量处理 |

**vs MapReduce**：

| 方面 | MapReduce | 数据流引擎 |
|------|-----------|------------|
| 编程模型 | Map/Reduce | 任意 DAG |
| 中间数据 | 写入 HDFS | 内存流转 |
| 迭代支持 | 效率低 | 高效 |

---

## 第11章：流处理

### 批处理 vs 流处理

| 方面 | 批处理 | 流处理 |
|------|--------|--------|
| 数据 | 有界，静态 | 无界，持续到达 |
| 延迟 | 分钟~小时 | 毫秒~秒 |
| 结果 | 一次性输出 | 持续更新 |

### 消息系统

**传统消息队列** (RabbitMQ)：
- 消息处理后删除
- 每条消息只被一个消费者处理

**日志型消息系统** (Kafka)：
- 消息持久化，可重放
- 分区保序
- 多消费者组独立消费

```
分区0: [msg0][msg3][msg6] → 消费者A
分区1: [msg1][msg4][msg7] → 消费者B
分区2: [msg2][msg5][msg8] → 消费者C
```

### 变更数据捕获 (CDC)

```
应用 → 数据库 → CDC工具(Debezium) → Kafka → 派生系统
```

**应用**：同步搜索索引、微服务集成、实时 ETL

### 事件溯源

```
传统方式：只存当前状态
┌ balance = 1000 ┐

事件溯源：存储所有事件
│ 1. 创建账户 balance=0    │
│ 2. 存款 +500             │
│ 3. 存款 +800             │
│ 4. 取款 -300             │
└ 当前: 0+500+800-300=1000 ┘
```

**优势**：完整审计、可重放、调试友好

### 时间语义

| 类型 | 定义 |
|------|------|
| 事件时间 | 事件实际发生的时间 |
| 处理时间 | 事件到达处理器的时间 |

### 窗口类型

```
滚动窗口：┌──┐┌──┐┌──┐ (固定大小，不重叠)
滑动窗口：┌────┐
            ┌────┐
              ┌────┐  (固定大小，可重叠)
会话窗口：┌──┐   ┌─────┐  ┌─┐ (基于活动间隙)
```

### 水位线 (Watermark)

> 不会再有 ≤ 该时间的事件到达

**迟到事件处理**：丢弃、更新结果、侧输出

### 流处理框架

| 框架 | 特点 |
|------|------|
| Kafka Streams | 轻量级库，与 Kafka 紧密集成 |
| Flink | 真正的流处理，强一致性 |
| Spark Streaming | 微批处理 |

### 流表对偶

```
流 → 表：聚合/累积（物化视图）
表 → 流：捕获变更（变更日志）
```

```sql
-- KSQL: 流转表
CREATE TABLE page_counts AS
  SELECT page_id, COUNT(*) as views
  FROM pageviews
  GROUP BY page_id;
```

---

## 第12章：数据系统的未来

### 数据集成

**现状**：多种专用工具（PostgreSQL + Redis + ES + Kafka）

**以日志为中心的架构**：

```
写入 → 事件日志(Kafka) → 数据库
              ↓        → 搜索索引
                       → 缓存
```

**Lambda vs Kappa**：

| 架构 | 特点 |
|------|------|
| Lambda | 批处理+流处理双路径，需维护两套代码 |
| Kappa | 只用流处理，日志保留足够长支持重放 |

### 分拆数据库

```
传统数据库 = 存储 + 事务 + 索引 + 复制 + 查询优化

分拆后：
Kafka(日志) → Flink(处理) → RocksDB(存储)
每个组件专注一件事
```

**主数据 vs 衍生数据**：

| 类型 | 说明 |
|------|------|
| 主数据 | 真相来源，写入时的输入 |
| 衍生数据 | 从主数据计算，可重建（索引、缓存） |

### 端到端正确性

**幂等性**：执行多次与执行一次效果相同

```
幂等：SET x = 5
非幂等：INCR x（需要去重）
```

**端到端论证**：只在每层保证正确不够，需在最终用户层面验证

### 审计与可追溯

**不可变日志的优势**：

```
传统：UPDATE email='new@...'（历史丢失）
事件日志：
  1. 注册 email='old@...'
  2. 更新 email='new@...'（完整历史）
```

### 伦理考量

| 问题 | 考量 |
|------|------|
| 隐私 | 收集什么数据？用于什么？ |
| 偏见 | 算法是否存在歧视？ |
| 透明度 | 用户能否理解决策过程？ |
| 问责 | 出错时谁负责？ |

### 设计原则

| 原则 | 说明 |
|------|------|
| 简单性 | 避免不必要的复杂性 |
| 可组合性 | 使用可组合的组件 |
| 可观测性 | 便于理解系统行为 |
| 可演化性 | 能适应变化的需求 |

### 未来趋势

```
1. 流批一体：批处理 = 有界流
2. 声明式数据管理：描述想要什么
3. 自动化运维：自动调优、扩缩容
4. 边缘计算：数据处理靠近产生地
```

---

## 全书总结

### 核心主题

| 主题 | 章节 | 要点 |
|------|------|------|
| 数据存储 | 2, 3, 4 | 选择合适的数据模型和存储引擎 |
| 分布式 | 5-9 | 理解分布式系统的权衡 |
| 数据处理 | 10, 11 | 批处理与流处理的统一 |
| 系统设计 | 1, 12 | 可靠、可扩展、可维护 |

### 关键要点

1. **没有银弹**：不同工具适合不同场景
2. **日志是关键**：事件日志是数据集成的基础
3. **衍生数据可重建**：主数据是真相来源
4. **端到端正确性**：只在某一层保证不够
5. **技术选择有社会影响**：需要考虑伦理问题
6. **简单性是美德**：避免不必要的复杂性

---

## 推荐阅读

| 书籍 | 主题 |
|------|------|
| 《Database Internals》 | 数据库内部原理 |
| 《Streaming Systems》 | 流处理深入 |
| 《Building Microservices》 | 微服务架构 |
| 《Clean Architecture》 | 软件架构 |

---

[上一部分：分布式数据](/2025/12/28/DDIA-Part2-分布式数据/) | [返回总览](/2025/12/28/DDIA-读书笔记-总览/)

